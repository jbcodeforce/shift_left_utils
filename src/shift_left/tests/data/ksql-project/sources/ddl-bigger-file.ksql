CREATE STREAM EQUIPMENT_STAGE_JSON_STREAM WITH (KAFKA_TOPIC='stage.uvs_pm_73xx_json_nok', VALUE_FORMAT='JSON_SR') AS 
Select 
SUBSTRING(recordData,1,INSTR(recordData, ',') -1) SERVICE,
SUBSTRING(recordData,INSTR(recordData,'host=') +5,INSTR(recordData, ',',INSTR(recordData,'host='), 1) - INSTR(recordData,'host=') -5) HOST,
SUBSTRING(recordData,INSTR(recordData,'port_id=') +8,INSTR(recordData, ',',INSTR(recordData,'port_id='), 1) - INSTR(recordData,'port_id=') -8) PORT_ID,
CAST(SUBSTRING(recordData,INSTR(recordData,'bandwidth=') +10,INSTR(recordData, ',',INSTR(recordData,'bandwidth='), 1) - INSTR(recordData,'bandwidth=') -10) AS INT) BANDWIDTH,
SUBSTRING(recordData,INSTR(recordData,'system_id=') +10,INSTR(recordData, ',',INSTR(recordData,'system_id='), 1) - INSTR(recordData,'system_id=') -10) SYSTEM_ID,
SUBSTRING(recordData,INSTR(recordData,'system_type=') +12,INSTR(recordData, ' ',INSTR(recordData,'system_type='), 1) - INSTR(recordData,'system_type=') -12) SYSTEM_TYPE,
CAST(SUBSTRING(recordData,INSTR(recordData,'octets_rx=') +10,INSTR(recordData, ',',INSTR(recordData,'octets_rx='), 1) - INSTR(recordData,'octets_rx=') -10) AS DOUBLE) OCTETS_RX,
CAST(SUBSTRING(recordData,INSTR(recordData,'octets_tx=') +10,INSTR(recordData, ',',INSTR(recordData,'octets_tx='), 1) - INSTR(recordData,'octets_tx=') -10) AS DOUBLE) OCTETS_TX,
CAST(SUBSTRING(recordData,INSTR(recordData,'unicast_rx=') +11,INSTR(recordData, ',',INSTR(recordData,'unicast_rx='), 1) - INSTR(recordData,'unicast_rx=') -11) AS DOUBLE) UNICAST_RX,
CAST(SUBSTRING(recordData,INSTR(recordData,'unicast_tx=') +11,INSTR(recordData, ',',INSTR(recordData,'unicast_tx='), 1) - INSTR(recordData,'unicast_tx=') -11) AS DOUBLE) UNICAST_TX,
REPLACE(SUBSTRING(recordData,INSTR(recordData,'op_state=') +9,INSTR(recordData, ',',INSTR(recordData,'op_state='), 1) - INSTR(recordData,'op_state=') -9),'"','') OP_STATE,
CAST(SUBSTRING(recordData,INSTR(recordData,'discards_tx=') +12,INSTR(recordData, ',',INSTR(recordData,'discards_tx='), 1) - INSTR(recordData,'discards_tx=') -12) AS DOUBLE) DISCARDS_TX,
CAST(SUBSTRING(recordData,INSTR(recordData,'discards_rx=') +12,INSTR(recordData, ',',INSTR(recordData,'discards_rx='), 1) - INSTR(recordData,'discards_rx=') -12) AS DOUBLE) DISCARDS_RX,
CAST(SUBSTRING(recordData,INSTR(recordData,'multicast_rx=') +13,INSTR(recordData, ',',INSTR(recordData,'multicast_rx='), 1) - INSTR(recordData,'multicast_rx=') -13) AS DOUBLE) MULTICAST_RX,
CAST(SUBSTRING(recordData,INSTR(recordData,'multicast_tx=') +13,INSTR(recordData, ',',INSTR(recordData,'multicast_tx='), 1) - INSTR(recordData,'multicast_tx=') -13) AS DOUBLE) MULTICAST_TX,
REPLACE(SUBSTRING(recordData,INSTR(recordData,'collectorHost=') +14,INSTR(recordData, ',',INSTR(recordData,'collectorHost='), 1) - INSTR(recordData,'collectorHost=') -14),'"','') COLLECTOR_HOST,
CAST(SUBSTRING(recordData,INSTR(recordData,'errors_tx=') +10,INSTR(recordData, ',',INSTR(recordData,'errors_tx='), 1) - INSTR(recordData,'errors_tx=') -10) AS DOUBLE) ERRORS_TX,
CAST(SUBSTRING(recordData,INSTR(recordData,'errors_rx=') +10,INSTR(recordData, ',',INSTR(recordData,'errors_rx='), 1) - INSTR(recordData,'errors_rx=') -10) AS DOUBLE) ERRORS_RX,
CAST(SUBSTRING(recordData,INSTR(recordData,'broadcast_tx=') +13,INSTR(recordData, ',',INSTR(recordData,'broadcast_tx='), 1) - INSTR(recordData,'broadcast_tx=') -13) AS DOUBLE) BROADCAST_TX,
CAST(SUBSTRING(recordData,INSTR(recordData,'broadcast_rx=') +13,INSTR(recordData, ',',INSTR(recordData,'broadcast_rx='), 1) - INSTR(recordData,'broadcast_rx=') -13) AS DOUBLE) BROADCAST_RX,
REPLACE(SUBSTRING(recordData,INSTR(recordData,'taskId=') +7,INSTR(recordData, ',',INSTR(recordData,'taskId='), 1) - INSTR(recordData,'taskId=') -7),'"','') taskId,
REPLACE(SUBSTRING(recordData,INSTR(recordData,'admin_state=') +12,INSTR(recordData, ',',INSTR(recordData,'admin_state='), 1) - INSTR(recordData,'admin_state=') -12),'"','') ADMIN_STATE,
REPLACE(SUBSTRING(recordData,INSTR(recordData,'connector=') +10,INSTR(recordData, ',',INSTR(recordData,'connector='), 1) - INSTR(recordData,'connector=') -10),'"','') "CONNECTOR",
CAST(SUBSTRING(recordData,INSTR(recordData,'utilization_rx=') +15,INSTR(recordData, ',',INSTR(recordData,'utilization_rx='), 1) - INSTR(recordData,'utilization_rx=') -15) AS DOUBLE) UTILIZATION_RX,
CAST(SUBSTRING(recordData,INSTR(recordData,'utilization_tx=') +15,INSTR(recordData, ',',INSTR(recordData,'utilization_tx='), 1) - INSTR(recordData,'utilization_tx=') -15) AS DOUBLE) UTILIZATION_TX,
CAST(SUBSTRING(recordData,INSTR(recordData,'nunicast_rx=') +12,INSTR(recordData, ',',INSTR(recordData,'nunicast_rx='), 1) - INSTR(recordData,'nunicast_rx=') -12) AS DOUBLE) NUNICAST_RX,
CAST(SUBSTRING(recordData,INSTR(recordData,'nunicast_tx=') +12,INSTR(recordData, ',',INSTR(recordData,'nunicast_tx='), 1) - INSTR(recordData,'nunicast_tx=') -12) AS DOUBLE) NUNICAST_TX,
CAST(SUBSTRING(recordData,INSTR(recordData,'total_pkts_rx=') +14,INSTR(recordData, ',',INSTR(recordData,'total_pkts_rx='), 1) - INSTR(recordData,'total_pkts_rx=') -14) AS DOUBLE) TOTAL_PKTS_RX,
CAST(SUBSTRING(recordData,INSTR(recordData,'total_pkts_tx=') +14,INSTR(recordData, ',',INSTR(recordData,'total_pkts_tx='), 1) - INSTR(recordData,'total_pkts_tx=') -14) AS DOUBLE) TOTAL_PKTS_TX,
CAST(SUBSTRING(recordData,INSTR(recordData,'discards_rx_pct=') +16,INSTR(recordData, ',',INSTR(recordData,'discards_rx_pct='), 1) - INSTR(recordData,'discards_rx_pct=') -16) AS DOUBLE) DISCARDS_RX_PCT,
CAST(SUBSTRING(recordData,INSTR(recordData,'discards_tx_pct=') +16,INSTR(recordData, ',',INSTR(recordData,'discards_tx_pct='), 1) - INSTR(recordData,'discards_tx_pct=') -16) AS DOUBLE) DISCARDS_TX_PCT,
CAST(SUBSTRING(recordData,INSTR(recordData,'errors_rx_pct=') +14,INSTR(recordData, ',',INSTR(recordData,'errors_rx_pct='), 1) - INSTR(recordData,'errors_rx_pct=') -14) AS DOUBLE) ERRORS_RX_PCT,
CAST(SUBSTRING(recordData,INSTR(recordData,'errors_tx_pct=') +14,INSTR(recordData, ' ',INSTR(recordData,'errors_tx_pct='), 1) - INSTR(recordData,'errors_tx_pct=') -14) AS DOUBLE) ERRORS_TX_PCT,
SUBSTRING(recordData,INSTR(recordData,'collection_ts=') +15, 14) COLLECTION_TS,
SUBSTRING(recordData,INSTR(recordData,'datetimeutc=') +13, 14) DATETIMEUTC,
REPLACE(SUBSTRING(recordData,INSTR(recordData, ' ',-1, 1)),' ','') "time"
from EQUIPMENT_STAGE_STREAM
WHERE SUBSTRING(recordData,1,INSTR(recordData, ',') -1) = '73xx_if_pm'
EMIT CHANGES;