CREATE STREAM MEASUREMENT_KPI_ALERT_STATUS
    WITH (kafka_topic='stage.measure_kpi_alert', value_format='JSON_SR') AS
SELECT  D.ERROR_RATE AS KPI_RESULT, D.*, C.*,
	CASE
		WHEN    C.DIRECTION = 'ascending'
			AND (D.ERROR_RATE) >= C.HIGHWATERMARK
			THEN 'CRITICAL'
		WHEN     C.DIRECTION = 'ascending'
			AND ((D.ERROR_RATE) >= C.LOWWATERMARK AND (D.ERROR_RATE) < C.HIGHWATERMARK)
			THEN 'MAJOR'
		WHEN     C.DIRECTION = 	'ascending'
			AND (D.ERROR_RATE) < C.LOWWATERMARK
			THEN 'OK'
		WHEN    C.DIRECTION = 'descending'
            AND (D.ERROR_RATE) <= C.LOWWATERMARK	
            THEN 'CRITICAL'
        WHEN    C.DIRECTION = 'descending'
            AND (D.ERROR_RATE) > C.LOWWATERMARK	 AND (D.ERROR_RATE) <= C.HIGHWATERMARK
            THEN 'MAJOR'
		WHEN    C.DIRECTION = 'descending'
		    AND (D.ERROR_RATE) > C.HIGHWATERMARK
			THEN 'OK'
	END AS TCASTATUS
FROM   MEASUREMENT_STAGE_STREAM D
INNER JOIN KPI_CONFIG_TABLE C
	ON D.SERVICE = C.DBTABLE
EMIT CHANGES ;