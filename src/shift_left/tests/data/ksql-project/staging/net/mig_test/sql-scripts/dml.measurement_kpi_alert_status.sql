INSERT INTO measurement_kpi_alert_status
SELECT 
    D.ERROR_RATE AS KPI_RESULT,
    D.SERVICE,
    D.ERROR_RATE,
    C.DBTABLE,
    C.DIRECTION,
    C.LOWWATERMARK,
    C.HIGHWATERMARK,
    CASE
        WHEN C.DIRECTION = 'ascending' AND (D.ERROR_RATE) >= C.HIGHWATERMARK THEN 'CRITICAL'
        WHEN C.DIRECTION = 'ascending' AND ((D.ERROR_RATE) >= C.LOWWATERMARK AND (D.ERROR_RATE) < C.HIGHWATERMARK) THEN 'MAJOR'
        WHEN C.DIRECTION = 'ascending' AND (D.ERROR_RATE) < C.LOWWATERMARK THEN 'OK'
        WHEN C.DIRECTION = 'descending' AND (D.ERROR_RATE) <= C.LOWWATERMARK THEN 'CRITICAL'
        WHEN C.DIRECTION = 'descending' AND (D.ERROR_RATE) > C.LOWWATERMARK AND (D.ERROR_RATE) <= C.HIGHWATERMARK THEN 'MAJOR'
        WHEN C.DIRECTION = 'descending' AND (D.ERROR_RATE) > C.HIGHWATERMARK THEN 'OK'
    END AS TCASTATUS
FROM measurement_stage_stream D
INNER JOIN kpi_config_table C
ON D.SERVICE = C.DBTABLE;